# WAF 日志功能说明

## 概述

本次更新为 Pek.WAF 添加了完善的日志输出功能，帮助开发者监控和调试 IP 黑名单、请求拦截等安全功能。

## 核心特性

### 1. 灵活的日志控制机制

日志输出支持**双重控制**（满足任一条件即输出详细日志）：

```csharp
// 日志判断逻辑
var allowDetailLog = PekSysSetting.Current.AllowRequestParams || XTrace.Log.Level <= LogLevel.Debug;
```

#### ✅ 方式一：PekSysSetting.AllowRequestParams（推荐）

**配置方式：**

```json
{
  "PekSysSetting": {
    "AllowRequestParams": true
  }
}
```

**优势：**
- 精准控制：只影响 WAF 相关的详细日志
- 热重载：修改配置后立即生效，无需重启
- 生产友好：不影响其他模块的日志输出
- 临时调试：适合生产环境临时排查问题

#### 方式二：日志级别控制

**配置方式：**

```csharp
XTrace.Log.Level = LogLevel.Debug;
```

或在 `appsettings.json` 中：

```json
{
  "NewLife": {
    "LogLevel": "Debug"
  }
}
```

**特点：**
- 全局影响：会影响所有使用 NewLife.Log 的模块
- 适用场景：开发环境全局调试

### 2. 分级日志输出

#### Debug 级别（详细调试日志）

**触发条件：** `AllowRequestParams = true` 或 日志级别 = `Debug`

**日志点：**

1. **WAFMiddleware.Invoke** - 请求评估
   ```
   [DEBUG] [WAFMiddleware.Invoke]:评估请求 - IP:192.168.1.100, Path:/api/test, Method:GET
   ```

2. **WebRequest.InSubnet** - 子网检查
   ```
   [DEBUG] [WebRequest.InSubnet]:子网检查 - RemoteIP:192.168.1.100, 网络:192.168.1.0/24, 匹配:true
   ```

3. **WebRequest.IpInFile** - IP文件加载
   ```
   [DEBUG] [WebRequest.IpInFile]:加载IP文件 - 文件:blacklist.txt, IP数量:150
   [DEBUG] [WebRequest.IpInFile]:IP文件检查 - RemoteIP:192.168.1.100, 文件:blacklist.txt, 匹配:true
   ```

4. **WebRequest.IsInIpList** - IP列表匹配
   ```
   [DEBUG] [WebRequest.IsInIpList]:解析IP列表 - 规则数量:3, 原始列表:192.168.1.0/24, 10.0.0.1
   [DEBUG] [WebRequest.IsInIpList]:IP匹配成功 - RemoteIP:192.168.1.100, 规则类型:Cidr, 规则值:192.168.1.0/24
   [DEBUG] [WebRequest.IsInIpList]:IP不在列表 - RemoteIP:192.168.1.200, 已检查规则数:5
   ```

#### Info/Warn 级别（生产环境）

**触发条件：** 始终输出（无需配置）

**日志点：**

1. **WAFMiddleware.UpdateCompiledRule** - 规则更新
   ```
   [INFO] [WAFMiddleware.UpdateCompiledRule]:规则已更新 - Operator: OrElse, Rules: 3
   ```

2. **WAFMiddleware.Invoke** - 拦截请求
   ```
   [WARN] [WAFMiddleware.Invoke]:拦截请求 - IP:192.168.1.100, Path:/admin, Method:POST, UserAgent:curl/7.68.0
   ```

## 使用场景

### 场景一：生产环境排查问题

**步骤：**

1. 默认配置（关闭详细日志）
   ```json
   {
     "PekSysSetting": {
       "AllowRequestParams": false
     },
     "NewLife": {
       "LogLevel": "Info"
     }
   }
   ```

2. 发现问题，需要查看详细日志
   ```json
   {
     "PekSysSetting": {
       "AllowRequestParams": true  // 临时开启
     }
   }
   ```

3. 查看日志，定位问题

4. 问题解决后关闭
   ```json
   {
     "PekSysSetting": {
       "AllowRequestParams": false  // 关闭详细日志
     }
   }
   ```

### 场景二：开发环境调试

**配置：**

```json
{
  "PekSysSetting": {
    "AllowRequestParams": true
  },
  "NewLife": {
    "LogLevel": "Debug"
  }
}
```

可以看到完整的请求处理流程和规则匹配细节。

### 场景三：验证IP黑名单规则

**配置规则：**

```json
{
  "Ruleset": {
    "MemberName": "RemoteIp",
    "Operator": "IsInIpList",
    "Inputs": ["192.168.1.100, 10.0.0.0/8"]
  },
  "PekSysSetting": {
    "AllowRequestParams": true
  }
}
```

**发送测试请求：**

```bash
curl http://localhost:5000/api/test
```

**查看日志输出：**

```log
[INFO]  [WAFMiddleware.UpdateCompiledRule]:规则已更新 - RemoteIp IsInIpList (Inputs)
[DEBUG] [WebRequest.IsInIpList]:解析IP列表 - 规则数量:2, 原始列表:192.168.1.100, 10.0.0.0/8
[DEBUG] [WAFMiddleware.Invoke]:评估请求 - IP:192.168.1.100, Path:/api/test, Method:GET
[DEBUG] [WebRequest.IsInIpList]:IP匹配成功 - RemoteIP:192.168.1.100, 规则类型:Exact, 规则值:192.168.1.100
[WARN]  [WAFMiddleware.Invoke]:拦截请求 - IP:192.168.1.100, Path:/api/test, Method:GET, UserAgent:curl/7.68.0
```

从日志可以清楚看到：
- ✅ 规则已加载
- ✅ IP列表已解析（2个规则）
- ✅ IP 192.168.1.100 匹配成功（精确匹配）
- ✅ 请求被拦截

## 性能说明

### 性能优化措施

1. **条件判断前置**
   ```csharp
   var allowDetailLog = PekSysSetting.Current.AllowRequestParams || XTrace.Log.Level <= LogLevel.Debug;
   if (allowDetailLog) {
       // 只有条件满足时才执行日志输出
   }
   ```

2. **局部变量缓存**
   - 在 `IsInIpList` 方法中使用 `allowDetailLog` 变量
   - 避免在循环中重复判断条件

3. **短路求值**
   - 使用 `||` 操作符，`AllowRequestParams = true` 时立即返回
   - 无需再检查日志级别

### 性能影响

- **生产环境（关闭详细日志）**：几乎零开销，只有简单的布尔判断
- **开启详细日志**：每个请求增加少量日志输出操作，影响可忽略

## 技术实现

### 依赖项

- **日志框架**: `NewLife.Log.XTrace`
- **配置类**: `Pek.Configs.PekSysSetting`
- **命名空间**: 
  - `using NewLife.Log;`
  - `using Pek.Configs;`

### 关键代码

**WAFMiddleware.cs**

```csharp
public async Task Invoke(HttpContext context)
{
    var wr = new WebRequest(context.Request, cacheProvider);

    // 日志控制逻辑
    var allowDetailLog = PekSysSetting.Current.AllowRequestParams || XTrace.Log.Level <= NewLife.Log.LogLevel.Debug;
    
    if (allowDetailLog)
    {
        XTrace.Log.Debug($"[WAFMiddleware.Invoke]:评估请求 - IP:{wr.RemoteIp}, Path:{wr.Path}, Method:{wr.Method}");
    }

    if (compiledRule(wr))
    {
        XTrace.Log.Warn($"[WAFMiddleware.Invoke]:拦截请求 - IP:{wr.RemoteIp}, Path:{wr.Path}, Method:{wr.Method}, UserAgent:{wr.UserAgent}");
        context.Response.StatusCode = StatusCodes.Status403Forbidden;
        return;
    }

    await next.Invoke(context).ConfigureAwait(false);
}
```

**WebRequest.cs**

```csharp
public Boolean IsInIpList(String ipList)
{
    // ... 前置检查代码 ...
    
    // 日志控制逻辑
    var allowDetailLog = PekSysSetting.Current.AllowRequestParams || NewLife.Log.XTrace.Log.Level <= NewLife.Log.LogLevel.Debug;
    
    if (parsedRules == null)
    {
        parsedRules = ParseIpList(ipList);
        cacheProvider.Cache.Set(cacheKey, parsedRules, 300);
        
        if (allowDetailLog)
        {
            NewLife.Log.XTrace.Log.Debug($"[WebRequest.IsInIpList]:解析IP列表 - 规则数量:{parsedRules.Length}, 原始列表:{ipList}");
        }
    }
    
    // ... 匹配逻辑 ...
}
```

## 最佳实践

### 生产环境

```json
{
  "PekSysSetting": {
    "AllowRequestParams": false  // 默认关闭
  },
  "NewLife": {
    "LogLevel": "Info"
  }
}
```

### 临时调试

```json
{
  "PekSysSetting": {
    "AllowRequestParams": true  // 临时开启，排查完问题改回 false
  }
}
```

### 开发环境

```json
{
  "PekSysSetting": {
    "AllowRequestParams": true
  },
  "NewLife": {
    "LogLevel": "Debug"
  }
}
```

## 常见问题

### Q: 为什么看不到详细日志？

**A:** 确保满足以下任一条件：
- `PekSysSetting.AllowRequestParams = true`
- 或 日志级别 = `Debug`

### Q: AllowRequestParams 和日志级别有什么区别？

**A:**
- **AllowRequestParams**: 只控制 WAF 相关日志，精准、安全，适合生产环境
- **日志级别 Debug**: 影响所有模块，日志量大，适合开发环境

### Q: 修改 AllowRequestParams 需要重启吗？

**A:** 不需要！配置支持热重载，修改后立即生效。

### Q: 生产环境开启详细日志有性能影响吗？

**A:** 影响非常小。只是增加日志输出操作，对请求处理性能几乎无影响。

### Q: 可以只看拦截日志吗？

**A:** 可以！默认配置（`AllowRequestParams = false` 且日志级别 >= `Info`）就只输出拦截日志。

## 相关文档

- [IP黑名单配置示例](./IP黑名单配置示例.md) - 详细的配置指南和使用示例
- [CHANGELOG.md](../CHANGELOG.md) - 完整的更新日志

## 总结

通过 `PekSysSetting.AllowRequestParams` 配置，你可以：

✅ 灵活控制 WAF 详细日志的输出  
✅ 在生产环境安全地临时开启调试  
✅ 不影响其他模块的日志输出  
✅ 快速定位 IP 黑名单相关问题  
✅ 验证规则配置是否生效  

这种设计既保证了生产环境的性能和日志清洁度，又提供了强大的调试能力！
