# Pek.WAF

åŸºäºDHæ¡†æ¶çš„Kestrel Web æœåŠ¡å™¨çš„åŸºæœ¬ WAFï¼ˆWeb Application Firewallï¼‰åº“ï¼Œæä¾›çµæ´»çš„è¯·æ±‚è¿‡æ»¤å’Œå®‰å…¨é˜²æŠ¤åŠŸèƒ½ã€‚

## ç‰¹æ€§

- ğŸ›¡ï¸ **çµæ´»çš„è§„åˆ™é…ç½®**ï¼šæ”¯æŒå¤šç§æ“ä½œç¬¦å’Œé€»è¾‘ç»„åˆ
- ğŸš€ **é«˜æ€§èƒ½**ï¼šåŸºäºè¡¨è¾¾å¼æ ‘çš„è§„åˆ™ç¼–è¯‘ï¼Œè¿è¡Œæ—¶æ€§èƒ½ä¼˜å¼‚
- ğŸ”§ **æ˜“äºé›†æˆ**ï¼šç®€å•çš„æ‰©å±•æ–¹æ³•ï¼Œå¿«é€Ÿé›†æˆåˆ°ç°æœ‰é¡¹ç›®
- ğŸ“ **è‡ªåŠ¨é…ç½®**ï¼šå½“é…ç½®ä¸å­˜åœ¨æ—¶è‡ªåŠ¨ç”Ÿæˆé»˜è®¤å®‰å…¨è§„åˆ™
- ğŸ¯ **å¤šç§è¿‡æ»¤æ¡ä»¶**ï¼šæ”¯æŒè·¯å¾„ã€User-Agentã€IPåœ°ç†ä½ç½®ç­‰å¤šç»´åº¦è¿‡æ»¤

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…

```bash
dotnet add package Pek.WAF
```

### 2. é…ç½®æœåŠ¡

åœ¨ `Program.cs` æˆ– `Startup.cs` ä¸­æ·»åŠ  WAF æœåŠ¡ï¼š

```csharp
using Pek.WAF.Extensions;

// æ·»åŠ  WAF æœåŠ¡
builder.Services.AddWebFirewall(builder.Configuration);

// ä½¿ç”¨ WAF ä¸­é—´ä»¶
app.UseWebFirewall();
```

### 3. é…ç½®è§„åˆ™

#### ä½¿ç”¨ DH/Pek æ¡†æ¶æ—¶çš„é…ç½®æ–‡ä»¶ä½ç½®

å¦‚æœæ‚¨åœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº† `ConfigFileHelper.SetConfig(builder.Configuration)` æ–¹æ³•ï¼Œç³»ç»Ÿä¼šæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§é¡ºåºæŸ¥æ‰¾ `Settings` ç›®å½•ï¼š

1. `{åº”ç”¨ç¨‹åºç›®å½•}/Settings/`
2. `{åº”ç”¨ç¨‹åºç›®å½•}/Data/Settings/`
3. `{åº”ç”¨ç¨‹åºç›®å½•}/../Settings/`
4. `{åº”ç”¨ç¨‹åºç›®å½•}/bin/Settings/`

è¯·å°†åŒ…å« WAF è§„åˆ™çš„ JSON é…ç½®æ–‡ä»¶ï¼ˆå¦‚ `Ruleset.json` æˆ–åœ¨ `appsettings.json` ä¸­åŒ…å«è§„åˆ™é…ç½®ï¼‰æ”¾ç½®åœ¨ä¸Šè¿°ä»»ä¸€ `Settings` ç›®å½•ä¸­ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨åŠ è½½è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰ `*.json` æ–‡ä»¶ã€‚

#### æ ‡å‡†é…ç½®æ–¹å¼

åœ¨ `appsettings.json` ä¸­æ·»åŠ è§„åˆ™é…ç½®ï¼š

```json
{
  "Ruleset": {
    "Operator": "OrElse",
    "Rules": [
      {
        "MemberName": "Path",
        "Operator": "EndsWith",
        "Inputs": [".php"]
      },
      {
        "MemberName": "Path",
        "Operator": "EndsWith",
        "Inputs": [".env"]
      },
      {
        "MemberName": "Path",
        "Operator": "EndsWith",
        "Inputs": [".git"]
      }
      // æ›´å¤šè§„åˆ™ç¤ºä¾‹ï¼ˆå¯æ ¹æ®éœ€è¦å¯ç”¨ï¼‰ï¼š
      // {
      //   "MemberName": "UserAgent",
      //   "Operator": "IsMatch",
      //   "TargetValue": "^(curl|java|python)"
      // },
      // {
      //   "MemberName": "IpCountry",
      //   "Operator": "IsInInput",
      //   "Inputs": ["CN", "RU"]
      // }
    ]
  }
}
```

## é…ç½®è¯´æ˜

### åŸºæœ¬ç»“æ„

```json
{
  "Ruleset": {
    "Operator": "OrElse",  // é€»è¾‘æ“ä½œç¬¦
    "Rules": [             // è§„åˆ™æ•°ç»„
      // å…·ä½“è§„åˆ™
    ]
  }
}
```

### æ”¯æŒçš„æ“ä½œç¬¦

#### å­—ç¬¦ä¸²æ“ä½œç¬¦
- `EndsWith`: æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ä»¥æŒ‡å®šå€¼ç»“å°¾
- `StartsWith`: æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ä»¥æŒ‡å®šå€¼å¼€å¤´
- `Contains`: æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«æŒ‡å®šå€¼
- `Equals`: æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ç­‰äºæŒ‡å®šå€¼
- `IsMatch`: ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…

#### é›†åˆæ“ä½œç¬¦
- `IsInInput`: æ£€æŸ¥å€¼æ˜¯å¦åœ¨æŒ‡å®šçš„è¾“å…¥åˆ—è¡¨ä¸­

#### é€»è¾‘æ“ä½œç¬¦
- `OrElse`: é€»è¾‘æˆ–ï¼ˆä»»ä¸€è§„åˆ™åŒ¹é…å³è§¦å‘ï¼‰
- `AndAlso`: é€»è¾‘ä¸ï¼ˆæ‰€æœ‰è§„åˆ™éƒ½åŒ¹é…æ‰è§¦å‘ï¼‰

### å¯ç”¨çš„è¯·æ±‚å±æ€§

- `Path`: è¯·æ±‚è·¯å¾„
- `Method`: HTTP æ–¹æ³•
- `UserAgent`: ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²
- `IpAddress`: å®¢æˆ·ç«¯ IP åœ°å€
- `IpCountry`: IP åœ°ç†ä½ç½®å›½å®¶ä»£ç 
- `Headers`: è¯·æ±‚å¤´
- `QueryString`: æŸ¥è¯¢å­—ç¬¦ä¸²
- `ContentType`: å†…å®¹ç±»å‹

## é«˜çº§é…ç½®ç¤ºä¾‹

### 1. User-Agent æ£€æµ‹

```json
{
  "MemberName": "UserAgent",
  "Operator": "IsMatch",
  "TargetValue": "^(curl|java|python)"
}
```

### 2. IP åœ°ç†ä½ç½®è¿‡æ»¤

```json
{
  "MemberName": "IpCountry",
  "Operator": "IsInInput",
  "Inputs": ["CN", "RU"]
}
```

### 3. HTTP æ–¹æ³•é™åˆ¶

```json
{
  "MemberName": "Method",
  "Operator": "IsInInput",
  "Inputs": ["POST", "PUT", "DELETE"]
}
```

### 4. ç®¡ç†è·¯å¾„ä¿æŠ¤

```json
{
  "MemberName": "Path",
  "Operator": "StartsWith",
  "Inputs": ["/admin", "/wp-admin", "/phpmyadmin"]
}
```

### 5. ç™½åå•è§„åˆ™ï¼ˆä½¿ç”¨ Negateï¼‰

```json
{
  "MemberName": "Path",
  "Operator": "EndsWith",
  "Inputs": [".html", ".css", ".js", ".png", ".jpg"],
  "Negate": true
}
```

## è§„åˆ™å±æ€§è¯´æ˜

- `MemberName`: è¦æ£€æŸ¥çš„è¯·æ±‚å±æ€§åç§°
- `Operator`: ä½¿ç”¨çš„æ“ä½œç¬¦
- `TargetValue`: ç›®æ ‡å€¼ï¼ˆç”¨äºæ­£åˆ™è¡¨è¾¾å¼ç­‰ï¼‰
- `Inputs`: è¾“å…¥å€¼åˆ—è¡¨ï¼ˆç”¨äºé›†åˆæ“ä½œï¼‰
- `Negate`: æ˜¯å¦å–åç»“æœï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸º falseï¼‰
- `Rules`: åµŒå¥—è§„åˆ™æ•°ç»„ï¼ˆç”¨äºå¤æ‚é€»è¾‘ç»„åˆï¼‰

## è‡ªåŠ¨é…ç½®

å¦‚æœæ²¡æœ‰åœ¨ `appsettings.json` ä¸­é…ç½® `Ruleset` èŠ‚ç‚¹ï¼ŒWAF ä¼šè‡ªåŠ¨ä½¿ç”¨é»˜è®¤é…ç½®ï¼ŒåŒ…å«ä»¥ä¸‹å®‰å…¨è§„åˆ™ï¼š

- é˜»æ­¢è®¿é—® `.php` æ–‡ä»¶
- é˜»æ­¢è®¿é—® `.env` æ–‡ä»¶
- é˜»æ­¢è®¿é—® `.git` ç›¸å…³æ–‡ä»¶

## æœ€ä½³å®è·µ

1. **æ€§èƒ½ä¼˜åŒ–**: å°†æœ€å¸¸åŒ¹é…çš„è§„åˆ™æ”¾åœ¨å‰é¢
2. **å®‰å…¨è€ƒè™‘**: å®šæœŸæ›´æ–°è§„åˆ™ä»¥åº”å¯¹æ–°çš„å¨èƒ
3. **æµ‹è¯•**: åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰å……åˆ†æµ‹è¯•è§„åˆ™
4. **ç›‘æ§**: è®°å½•è¢«é˜»æ­¢çš„è¯·æ±‚ä»¥åˆ†ææ”»å‡»æ¨¡å¼
5. **ç™½åå•**: è€ƒè™‘ä½¿ç”¨ `Negate` å±æ€§åˆ›å»ºç™½åå•è§„åˆ™

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚è¯¦æƒ…è¯·å‚é˜… [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ã€‚